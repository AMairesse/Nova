{% extends 'base.html' %}
{% load i18n %} {% load static %}

{% block content %}
<div
  class="container-fluid h-100 p-0"
  style="overflow: hidden;"
  id="continuous-page-root"
  data-url-index="{% url 'index' %}"
  data-url-add-message="{% url 'continuous_add_message' %}"
  data-url-message-list="{% url 'continuous_messages' %}"
  data-url-running-tasks-base="/running-tasks/"
  data-url-load-days="{% url 'continuous_days' %}"
  data-url-regenerate-summary="{% url 'continuous_regenerate_summary' %}"
  data-url-day-summary="{% url 'continuous_day' '__DAY__' %}"
  data-today-label="{{ today_label|date:'Y-m-d' }}"
  data-url-file-list="{% url 'file_list' 0 %}"
  data-url-file-upload="{% url 'file_upload' 0 %}"
  data-url-file-delete="{% url 'file_delete' 0 %}"
  data-url-interaction-answer="{% url 'interaction_answer' 0 %}"
  data-url-interaction-cancel="{% url 'interaction_cancel' 0 %}"
>
  <div class="row g-0 main-content-row">
    <!-- Days Sidebar (Desktop) -->
    <div class="col-lg-3 d-none d-lg-block border-end d-flex flex-column h-100" id="threads-sidebar">
      <div class="continuous-days-toolbar p-3 border-bottom bg-light">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="mb-0">{% trans "Days" %}</h5>
          <button class="btn btn-sm btn-outline-primary" id="continuous-load-days" type="button" title="{% trans 'Refresh days' %}">
            <i class="bi bi-arrow-clockwise"></i>
          </button>
        </div>

        <div class="btn-group btn-group-sm w-100 mb-2" role="group" aria-label="{% trans 'Day quick actions' %}">
          <button class="btn btn-outline-secondary" id="continuous-day-latest-btn" type="button">
            {% trans "Latest messages" %}
          </button>
          <button class="btn btn-outline-secondary" id="continuous-day-today-btn" type="button">
            {% trans "Today" %}
          </button>
        </div>

        <label class="form-label small text-muted mb-1" for="continuous-day-jump-input">{% trans "Go to day" %}</label>
        <input type="date" class="form-control form-control-sm mb-2" id="continuous-day-jump-input" />

        <label class="form-label small text-muted mb-1" for="continuous-day-search-input">{% trans "Filter days" %}</label>
        <input
          type="text"
          class="form-control form-control-sm"
          id="continuous-day-search-input"
          placeholder="{% trans 'YYYY, YYYY-MM, YYYY-MM-DD' %}"
          autocomplete="off"
        />
      </div>
      <div id="threads-container">
        <div id="threads-list">
          <div class="text-muted small p-3">{% trans "Loading days…" %}</div>
        </div>
      </div>
    </div>

    <!-- Message Area (Center) -->
    <div class="col-12 d-flex flex-column h-100" id="message-area" data-files-visible="true" data-days-visible="true">
      <div class="d-flex justify-content-between align-items-center p-3 border-bottom bg-light d-none d-lg-flex">
        <h5 class="mb-0">{% trans "Continuous" %}</h5>
        <div class="d-flex gap-2">
          <button
            class="btn btn-sm btn-outline-secondary"
            type="button"
            id="continuous-days-toggle-btn"
            aria-expanded="true"
            aria-controls="threads-sidebar"
            title="{% trans 'Toggle days panel' %}"
          >
            <i class="bi bi-layout-sidebar-inset" id="continuous-days-toggle-icon"></i>
          </button>
          <button class="btn btn-sm btn-outline-secondary" type="button" id="files-toggle-btn" aria-expanded="true" aria-controls="files-sidebar">
            <i class="bi bi-layout-sidebar-inset-reverse" id="files-toggle-icon"></i>
          </button>
        </div>
      </div>

      <!-- Day summary (client-rendered from /continuous/day/<day>/, no SYSTEM message injection).
           The JS moves this node inside the message scroll container (#conversation-container)
           after messages are loaded, so it scrolls with the timeline. -->
      <div class="border-bottom bg-white" id="continuous-day-summary" style="display:none;">
        <div class="d-flex align-items-center justify-content-between px-3 py-2">
          <div class="fw-semibold" id="continuous-day-summary-title">{% trans "Day Summary" %}</div>
          <button class="btn btn-sm btn-outline-secondary" type="button" id="continuous-regenerate-summary">
            <i class="bi bi-arrow-clockwise"></i>
            <span class="d-none d-sm-inline">{% trans "Regenerate summary" %}</span>
          </button>
        </div>
        <div class="px-3 pb-3">
          <div id="continuous-summary-updated-event" class="text-muted small mb-2" style="display:none;"></div>
          <div id="continuous-summary-html" class="prose"></div>
        </div>
      </div>

      <div id="message-container" class="d-flex flex-column flex-grow-1" style="min-height: 0;">
        <div class="p-3 text-muted">{% trans "Loading messages…" %}</div>
      </div>
    </div>

    <!-- Files Sidebar (Desktop) -->
    <div class="col-lg-2 d-none d-lg-block border-start d-flex flex-column h-100" id="files-sidebar">
      <div id="file-sidebar-content" class="flex-grow-1 overflow-auto" style="min-height: 0;"></div>
    </div>
  </div>

  <!-- Mobile Days Offcanvas (reuses threads offcanvas slot) -->
  <div class="offcanvas offcanvas-start" tabindex="-1" id="threadsOffcanvas" aria-labelledby="threadsOffcanvasLabel">
    <div class="offcanvas-header border-bottom d-flex justify-content-between align-items-center">
      <h5 class="offcanvas-title" id="threadsOffcanvasLabel">{% trans "Days" %}</h5>
      <div class="d-flex gap-2">
        <button class="btn btn-sm btn-outline-primary" id="continuous-load-days-mobile" type="button" title="{% trans 'Refresh days' %}">
          <i class="bi bi-arrow-clockwise"></i>
        </button>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
      </div>
    </div>
    <div class="offcanvas-body p-0 d-flex flex-column" style="min-height: 0;">
      <div class="continuous-days-toolbar p-3 border-bottom bg-light">
        <div class="btn-group btn-group-sm w-100 mb-2" role="group" aria-label="{% trans 'Day quick actions' %}">
          <button class="btn btn-outline-secondary" id="continuous-day-latest-btn-mobile" type="button">
            {% trans "Latest messages" %}
          </button>
          <button class="btn btn-outline-secondary" id="continuous-day-today-btn-mobile" type="button">
            {% trans "Today" %}
          </button>
        </div>

        <label class="form-label small text-muted mb-1" for="continuous-day-jump-input-mobile">{% trans "Go to day" %}</label>
        <input type="date" class="form-control form-control-sm mb-2" id="continuous-day-jump-input-mobile" />

        <label class="form-label small text-muted mb-1" for="continuous-day-search-input-mobile">{% trans "Filter days" %}</label>
        <input
          type="text"
          class="form-control form-control-sm"
          id="continuous-day-search-input-mobile"
          placeholder="{% trans 'YYYY, YYYY-MM, YYYY-MM-DD' %}"
          autocomplete="off"
        />
      </div>
      <div id="mobile-threads-container">
        <div id="mobile-threads-list">
          <div class="text-muted small p-3">{% trans "Loading days…" %}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Mobile Files/Webapps Offcanvas: unchanged from Threads -->
  <div class="offcanvas offcanvas-end" tabindex="-1" id="filesOffcanvas" aria-labelledby="filesOffcanvasLabel">
    <div class="offcanvas-header border-bottom d-flex justify-content-between align-items-center">
      <h5 class="offcanvas-title" id="filesOffcanvasLabel">{% trans "Files & Webapps" %}</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body p-0 d-flex flex-column">
      <ul class="nav nav-tabs px-2 pt-2" id="mobile-files-webapps-tabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="mobile-tab-files" data-bs-toggle="tab" data-bs-target="#mobile-files-pane" type="button" role="tab" aria-controls="mobile-files-pane" aria-selected="true">
            <i class="bi bi-files me-1"></i>{% trans "Files" %}
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="mobile-tab-webapps" data-bs-toggle="tab" data-bs-target="#mobile-webapps-pane" type="button" role="tab" aria-controls="mobile-webapps-pane" aria-selected="false">
            <i class="bi bi-window me-1"></i>{% trans "Webapps" %}
          </button>
        </li>
      </ul>

      <div class="d-flex justify-content-between align-items-center px-2 py-2 border-bottom bg-light" id="mobile-files-toolbar">
        <div class="small text-muted">{% trans "Upload files" %}</div>
        <div>
          <button id="upload-files-btn-mobile" class="btn btn-sm btn-primary me-1" title="{% trans 'Upload files' %}">
            <i class="bi bi-upload"></i>
          </button>
          <button id="upload-directory-btn-mobile" class="btn btn-sm btn-primary" title="{% trans 'Upload directory' %}">
            <i class="bi bi-folder-plus"></i>
          </button>
        </div>
      </div>

      <div class="tab-content flex-grow-1 overflow-auto" id="mobile-files-webapps-tabcontent">
        <div class="tab-pane fade show active" id="mobile-files-pane" role="tabpanel" aria-labelledby="mobile-tab-files" tabindex="0">
          <div id="file-sidebar-content-mobile"></div>
        </div>
        <div class="tab-pane fade" id="mobile-webapps-pane" role="tabpanel" aria-labelledby="mobile-tab-webapps" tabindex="0">
          <div id="webapps-list-container-mobile" class="p-2">
            <p class="text-muted mb-0">{% trans "Loading webapps..." %}</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="{% static 'js/responsive.js' %}" defer></script>
<script src="{% static 'js/voice_recognition.js' %}" defer></script>
<script src="{% static 'js/message-renderer.js' %}" defer></script>
<script src="{% static 'js/streaming-manager.js' %}" defer></script>
<script src="{% static 'js/message-manager.js' %}" defer></script>
<script src="{% static 'js/preview-manager.js' %}" defer></script>
<script src="{% static 'js/thread-manager.js' %}" defer></script>
<script src="{% static 'js/continuous-page.js' %}" defer></script>
<script src="{% static 'js/file-operations.js' %}" defer></script>
<script src="{% static 'js/sidebar-manager.js' %}" defer></script>
<script src="{% static 'js/websocket-manager.js' %}" defer></script>
<script src="{% static 'js/webapp-integration.js' %}" defer></script>
<script src="{% static 'js/files.js' %}" defer></script>
<script src="{% static 'js/nova-thread-bootstrap.js' %}" defer></script>

{% endblock %}
