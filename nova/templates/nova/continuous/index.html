{% extends 'base.html' %}
{% load i18n %} {% load static %}

{% block content %}
<div class="container-fluid h-100 p-0" style="overflow: hidden;">
  <div class="row g-0 main-content-row">
    <!-- Days Sidebar (Desktop) -->
    <div class="col-lg-2 d-none d-lg-block border-end d-flex flex-column h-100" id="threads-sidebar">
      <div class="d-flex justify-content-between align-items-center p-3 border-bottom bg-light">
        <h5 class="mb-0">{% trans "Days" %}</h5>
        <button class="btn btn-sm btn-outline-primary" id="continuous-load-days" data-offset="0">
          <i class="bi bi-arrow-clockwise"></i>
        </button>
      </div>
      <div id="threads-container">
        <div id="threads-list">
          <div class="text-muted small p-3">{% trans "Loading days…" %}</div>
        </div>
      </div>
    </div>

    <!-- Message Area (Center) -->
    <div class="col-12 d-flex flex-column h-100" id="message-area" data-files-visible="true">
      <div class="d-flex justify-content-between align-items-center p-3 border-bottom bg-light d-none d-lg-flex">
        <h5 class="mb-0">{% trans "Continuous" %}</h5>
        <button class="btn btn-sm btn-outline-secondary" type="button" id="files-toggle-btn" aria-expanded="true" aria-controls="files-sidebar">
          <i class="bi bi-layout-sidebar-inset-reverse" id="files-toggle-icon"></i>
        </button>
      </div>
      <div id="message-container" class="d-flex flex-column flex-grow-1" style="min-height: 0;">
        <div class="p-3 text-muted">{% trans "Loading messages…" %}</div>
      </div>
    </div>

    <!-- Files Sidebar (Desktop) -->
    <div class="col-lg-2 d-none d-lg-block border-start d-flex flex-column h-100" id="files-sidebar">
      <div id="file-sidebar-content" class="flex-grow-1 overflow-auto" style="min-height: 0;"></div>
    </div>
  </div>

  <!-- Mobile Days Offcanvas (reuses threads offcanvas slot) -->
  <div class="offcanvas offcanvas-start" tabindex="-1" id="threadsOffcanvas" aria-labelledby="threadsOffcanvasLabel">
    <div class="offcanvas-header border-bottom d-flex justify-content-between align-items-center">
      <h5 class="offcanvas-title" id="threadsOffcanvasLabel">{% trans "Days" %}</h5>
      <div class="d-flex gap-2">
        <button class="btn btn-sm btn-outline-primary" id="continuous-load-days-mobile" data-offset="0">
          <i class="bi bi-arrow-clockwise"></i>
        </button>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
      </div>
    </div>
    <div class="offcanvas-body p-0 d-flex flex-column" style="min-height: 0;">
      <div id="mobile-threads-container">
        <div id="mobile-threads-list">
          <div class="text-muted small p-3">{% trans "Loading days…" %}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Mobile Files/Webapps Offcanvas: unchanged from Threads -->
  <div class="offcanvas offcanvas-end" tabindex="-1" id="filesOffcanvas" aria-labelledby="filesOffcanvasLabel">
    <div class="offcanvas-header border-bottom d-flex justify-content-between align-items-center">
      <h5 class="offcanvas-title" id="filesOffcanvasLabel">{% trans "Files & Webapps" %}</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body p-0 d-flex flex-column">
      <ul class="nav nav-tabs px-2 pt-2" id="mobile-files-webapps-tabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="mobile-tab-files" data-bs-toggle="tab" data-bs-target="#mobile-files-pane" type="button" role="tab" aria-controls="mobile-files-pane" aria-selected="true">
            <i class="bi bi-files me-1"></i>{% trans "Files" %}
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="mobile-tab-webapps" data-bs-toggle="tab" data-bs-target="#mobile-webapps-pane" type="button" role="tab" aria-controls="mobile-webapps-pane" aria-selected="false">
            <i class="bi bi-window me-1"></i>{% trans "Webapps" %}
          </button>
        </li>
      </ul>

      <div class="d-flex justify-content-between align-items-center px-2 py-2 border-bottom bg-light" id="mobile-files-toolbar">
        <div class="small text-muted">{% trans "Upload files" %}</div>
        <div>
          <button id="upload-files-btn-mobile" class="btn btn-sm btn-primary me-1" title="{% trans 'Upload files' %}">
            <i class="bi bi-upload"></i>
          </button>
          <button id="upload-directory-btn-mobile" class="btn btn-sm btn-primary" title="{% trans 'Upload directory' %}">
            <i class="bi bi-folder-plus"></i>
          </button>
        </div>
      </div>

      <div class="tab-content flex-grow-1 overflow-auto" id="mobile-files-webapps-tabcontent">
        <div class="tab-pane fade show active" id="mobile-files-pane" role="tabpanel" aria-labelledby="mobile-tab-files" tabindex="0">
          <div id="file-sidebar-content-mobile"></div>
        </div>
        <div class="tab-pane fade" id="mobile-webapps-pane" role="tabpanel" aria-labelledby="mobile-tab-webapps" tabindex="0">
          <div id="webapps-list-container-mobile" class="p-2">
            <p class="text-muted mb-0">{% trans "Loading webapps..." %}</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  window.NovaApp = window.NovaApp || {};
  window.NovaApp.urls = {
    index: "{% url 'index' %}",
    // Continuous-specific endpoints
    addMessage: "{% url 'continuous_add_message' %}",
    messageList: "{% url 'continuous_messages' %}",
    runningTasksBase: "/running-tasks/",
    // Threads endpoints are not used from this page; keep minimal set.
    loadDays: "{% url 'continuous_days' %}",
    regenerateSummary: "{% url 'continuous_regenerate_summary' %}",
    // Files endpoints (same as thread mode; URLs require thread_id substitution handled by FileManager)
    fileList: "{% url 'file_list' 0 %}",
    fileUpload: "{% url 'file_upload' 0 %}",
    fileDelete: "{% url 'file_delete' 0 %}",
  };
  window.NovaApp.storageKeys = { threadId: 'lastContinuousThreadId' };
</script>

<script>
  (function () {
    async function loadDaysInto(containerId) {
      const el = document.getElementById(containerId);
      if (!el) return;
      const resp = await fetch(`${window.NovaApp.urls.loadDays}?offset=0&limit=30`, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
      const data = await resp.json();
      el.innerHTML = data.html || '<div class="text-muted p-3">No days yet.</div>';
    }

    async function loadMessages() {
      const resp = await fetch(window.NovaApp.urls.messageList, { headers: { 'X-AJAX': 'true' } });
      const html = await resp.text();
      const mc = document.getElementById('message-container');
      if (mc) mc.innerHTML = html;
      // Announce thread id for other modules (files/webapps)
      // Thread id is embedded in the message container hidden field.
      const tid = document.querySelector('#message-container input[name="thread_id"]')?.value;
      document.dispatchEvent(new CustomEvent('threadChanged', { detail: { threadId: tid || null } }));
    }

    document.getElementById('continuous-load-days')?.addEventListener('click', (e) => {
      e.preventDefault();
      loadDaysInto('threads-list');
    });
    document.getElementById('continuous-load-days-mobile')?.addEventListener('click', (e) => {
      e.preventDefault();
      loadDaysInto('mobile-threads-list');
    });

    loadDaysInto('threads-list');
    loadDaysInto('mobile-threads-list');
    loadMessages();
  })();
</script>

<script src="{% static 'js/responsive.js' %}" defer></script>
<script src="{% static 'js/voice_recognition.js' %}" defer></script>
<script src="{% static 'js/message-renderer.js' %}" defer></script>
<script src="{% static 'js/streaming-manager.js' %}" defer></script>
<script src="{% static 'js/message-manager.js' %}" defer></script>
<script src="{% static 'js/preview-manager.js' %}" defer></script>
<script src="{% static 'js/thread-manager.js' %}" defer></script>
<script src="{% static 'js/file-operations.js' %}" defer></script>
<script src="{% static 'js/sidebar-manager.js' %}" defer></script>
<script src="{% static 'js/websocket-manager.js' %}" defer></script>
<script src="{% static 'js/webapp-integration.js' %}" defer></script>
<script src="{% static 'js/files.js' %}" defer></script>
<script src="{% static 'js/nova-thread-bootstrap.js' %}" defer></script>

{% endblock %}
