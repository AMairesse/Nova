<!-- nova/templates/nova/message_container.html -->
{% load static %} {% load i18n %}


<div class="d-flex flex-column h-100">
  <!-- Scrollable conversation area -->
  <div id="conversation-container" class="flex-grow-1 overflow-auto p-2 p-sm-3" style="min-height: 0;">
    <!-- Messages list container -->
    <div id="messages-list">
      {% for message in messages %}
      <div id="message-{{ message.id }}" class="message mb-3" data-message-id="{{ message.id }}">
        {% if message.message_type == 'interaction_question' %}
        <!-- Interaction question message -->
        <!-- Only display the question message if it is not PENDING 
             because if it is then the JS will display the question box -->
        {% if message.interaction.status != 'PENDING' %}
        <div class="card border-warning">
          <div class="card-body py-2">
            <div class="d-flex align-items-center mb-2">
              <i class="bi bi-question-circle text-warning me-2"></i>
              <strong>Question</strong>
            </div>
            <div>{{ message.rendered_html }}</div>
            {% if message.interaction %}
            <div class="mt-2 small text-muted">
              {% if message.interaction.origin_name %}
                Asked by {{ message.interaction.origin_name }}
              {% endif %}
              {% if message.interaction.created_at %}
                on {{ message.interaction.created_at|date:"M d, Y H:i" }}
              {% endif %}
            </div>
            {% endif %}
          </div>
        </div>
        {% endif %}
        {% elif message.message_type == 'interaction_answer' %}
        <!-- Interaction answer message -->
        <div class="card border-success">
          <div class="card-body py-2">
            <div class="d-flex align-items-center mb-2">
              <i class="bi bi-check-circle text-success me-2"></i>
              <strong>Answer</strong>
            </div>
            <div>{{ message.rendered_html }}</div>
            {% if message.interaction %}
            <div class="mt-2 small text-muted">
              {% if message.interaction.created_at %}
                Answered on {{ message.interaction.created_at|date:"M d, Y H:i" }}
              {% endif %}
            </div>
            {% endif %}
          </div>
        </div>
        {% elif message.actor == Actor.USER %}
        <div class="card border-primary">
          <div class="card-body py-2">
            <strong class="text-primary">{{ message.rendered_html }}</strong>
            {% if message.file_count %}
              <div class="mt-2 small text-muted">
                {% blocktrans count file_count=message.file_count %}
                  {{ file_count }} file was shared with this message.
                {% plural %}
                  {{ file_count }} files were shared with this message.
                {% endblocktrans %}
              </div>
            {% endif %}
          </div>
        </div>
        {% elif message.actor == Actor.AGENT %}
        <div class="card border-secondary">
          <div class="card-body py-2">
            {{ message.rendered_html }}
          </div>
          <!-- Context indication -->
          {% if message.internal_data.max_context %}
          <div class="card-footer py-1 text-muted small d-flex justify-content-end align-items-center">
            {% if message.is_last_agent_message %}
            <a href="#" class="compact-thread-link text-decoration-none small me-2" title="{% trans 'Summarize conversation to save context space' %}" aria-label="{% trans 'Summarize conversation to save context space' %}">
              <i class="bi bi-compress me-1"></i>{% trans "Compact" %}
            </a>
            {% endif %}
            <div class="card-footer-consumption">
              {% if message.internal_data.real_tokens is not None %}
                {% trans "Context consumption" %}: {{ message.internal_data.real_tokens }} / {{ message.internal_data.max_context }} ({% trans "real" %})
              {% elif message.internal_data.approx_tokens %}
                {% trans "Context consumption" %}: {{ message.internal_data.approx_tokens }} / {{ message.internal_data.max_context }} ({% trans "approximated" %})
              {% elif message.internal_data.context_tokens %}
                {% trans "Context consumption" %}: {{ message.internal_data.context_tokens }} / {{ message.internal_data.max_context }} ({% trans "approximated" %})
              {% endif %}
            </div>
          </div>
          {% endif %}
        </div>
        {% endif %}
      </div>
      {% endfor %}

      <!-- Render pending interactions as interactive cards -->
      {% for interaction in pending_interactions %}
      <div id="interaction-card-{{ interaction.id }}" class="message mb-3">
        <div class="card border-warning">
          <div class="card-body">
            <div class="d-flex align-items-center mb-2">
              <i class="bi bi-question-circle text-warning me-2"></i>
              <strong>
                {% if interaction.origin_name %}
                  {{ interaction.origin_name }} asks:
                {% else %}
                  Question:
                {% endif %}
              </strong>
            </div>
            <div class="mb-2">{{ interaction.question }}</div>
            <div class="mb-2">
              <textarea class="form-control" id="interaction-answer-input-{{ interaction.id }}" rows="2" placeholder="{% trans 'Type your answer...' %}"></textarea>
              {% if interaction.schema %}
                <div class="form-text text-muted mt-1">{% trans 'Answer format may be structured; plain text is also accepted.' %}</div>
              {% endif %}
            </div>
            <div class="d-flex gap-2">
              <button type="button" class="btn btn-sm btn-primary interaction-answer-btn" data-interaction-id="{{ interaction.id }}" aria-label="{% trans 'Answer the question' %}">
                <i class="bi bi-check2-circle me-1"></i>{% trans 'Answer' %}
              </button>
              <button type="button" class="btn btn-sm btn-outline-secondary interaction-cancel-btn" data-interaction-id="{{ interaction.id }}" aria-label="{% trans 'Cancel the question' %}">
                <i class="bi bi-x-circle me-1"></i>{% trans 'Cancel' %}
              </button>
              <div class="ms-auto small text-muted interaction-status"></div>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>

  </div>

  <!-- Progress indicator - fixed position when visible -->
  <div id="task-progress" class="d-none message-input-area p-3">
    <div class="d-flex align-items-center gap-3">
      <div class="spinner-border spinner-border-sm text-primary" role="status">
        <span class="visually-hidden">{% trans "Working..." %}</span>
      </div>
      <div class="flex-grow-1">
        <small id="progress-logs" class="text-muted"></small>
      </div>
      <div id="task-status"></div>
    </div>
  </div>

  <!-- Message input area - only for today (or when day filter is not active) -->
  {% if allow_posting|default:True %}
  {% with nb_agents=user_agents|length %} {% if nb_agents == 0 %}
  <div class="alert alert-info text-center message-input-area m-0 rounded-0">
    {% trans "No agents configured yet." %}<br />
    <a href="{% url 'user_settings:dashboard' %}#pane-agents" class="alert-link">
      {% trans "Create one now" %}
    </a>
  </div>
  {% else %}
  <div class="message-input-area p-2 p-sm-3">
    <form id="message-form" method="post" enctype="multipart/form-data">
      {% csrf_token %}
      <input
        type="hidden"
        name="thread_id"
        value="{{ thread_id|default_if_none:'' }}"
      />
      
      <!-- Message input group with integrated agent selector -->
      <div class="input-group mb-2">
        <div class="input-group-prepend">
          <div class="dropdown">
            <button
              class="btn btn-outline-secondary btn-sm dropdown-toggle agent-selector-btn"
              type="button"
              data-bs-toggle="dropdown"
              aria-expanded="false"
              id="dropdownMenuButton"
              data-bs-placement="top"
              title="{% if default_agent %}{{ default_agent.name }}{% else %}{% trans 'Select an agent' %}{% endif %}"
              aria-label="{% if default_agent %}{{ default_agent.name }}{% else %}{% trans 'Select an agent' %}{% endif %}"
            >
              <i class="bi bi-robot"></i>
            </button>
            <ul class="dropdown-menu">
              {% for agent in user_agents %}
              <li>
                <a class="dropdown-item agent-dropdown-item" href="#" data-value="{{ agent.id }}">
                  <i class="bi bi-robot me-2"></i>{{ agent.name }}
                </a>
              </li>
              {% endfor %}
              {% if nb_agents == 0 %}
              <li>
                <span class="dropdown-item-text text-muted">
                  {% trans "No agents available" %}
                </span>
              </li>
              {% endif %}
            </ul>
          </div>
        </div>

        <!-- Hidden input -->
        <input
          type="hidden"
          name="selected_agent"
          id="selectedAgentInput"
          value="{% if default_agent %}{{ default_agent.id }}{% endif %}"
        />

        <textarea class="form-control auto-resize-textarea"
                  name="new_message"
                  placeholder="{% trans 'Type your message...' %}"
                  rows="1"
                  maxlength="2000"
                  autofocus></textarea>
        <button
          type="button"
          id="voice-btn"
          class="btn btn-outline-secondary"
          title="{% trans 'Voice input' %}"
        >
          <i class="bi bi-mic"></i>
          <span class="visually-hidden">{% trans "Voice input" %}</span>
        </button>
        <button
          type="submit"
          id="send-btn"
          class="btn btn-primary {% if nb_agents == 0 %}disabled{% endif %}"
          {% if nb_agents == 0 %}disabled{% endif %}
        >
          <i class="bi bi-send-fill"></i>
          <span class="visually-hidden">{% trans "Send" %}</span>
        </button>
      </div>
    </form>
  </div>
  {% endif %} {% endwith %}
  {% endif %}

  <!-- Sub-agent Summarization Confirmation Modal -->
  <div class="modal fade" id="subAgentConfirmationModal" tabindex="-1" aria-labelledby="subAgentConfirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="subAgentConfirmationModalLabel">{% trans "Sub-agent summarization" %}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p><strong>{% trans "Sub-agents have accumulated context in this conversation:" %}</strong></p>
          <ul id="subAgentList" class="list-group mb-3"></ul>
          <p>{% trans "Do you want to optimize their context as well?" %}</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="window.NovaApp.messageManager.confirmSummarize(false)">
            {% trans "No, only main agent" %}
          </button>
          <button type="button" class="btn btn-primary" onclick="window.NovaApp.messageManager.confirmSummarize(true)">
            {% trans "Yes, optimize all" %}
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
