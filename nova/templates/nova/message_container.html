<!-- nova/templates/nova/message_container.html -->
{% load static %} {% load i18n %}

<div class="d-flex flex-column h-100">
  <!-- Scrollable conversation area -->
  <div id="conversation-container" class="flex-grow-1 overflow-auto p-3" style="min-height: 0;">
    <!-- Messages list container -->
    <div id="messages-list">
      {% for message in messages %}
      <div id="message-{{ message.id }}" class="message mb-3" data-message-id="{{ message.id }}">
        {% if message.actor == Actor.USER %}
        <div class="card border-primary">
          <div class="card-body py-2">
            <strong class="text-primary">{{ message.rendered_html }}</strong>
            <!-- Affichage fichiers attachÃ©s -->
            {% if message.file_count %}
              <div class="mt-2 small text-muted">
                {% blocktrans count file_count=message.file_count %}
                  {{ file_count }} file was shared with this message.
                {% plural %}
                  {{ file_count }} files were shared with this message.
                {% endblocktrans %}
              </div>
            {% endif %}
          </div>
        </div>
        {% elif message.actor == Actor.AGENT %}
        <div class="card border-secondary">
          <div class="card-body py-2">
            {{ message.rendered_html }}
          </div>
          <!-- Context indication -->
          {% if message.internal_data.max_context %}
          <div class="card-footer py-1 text-muted small text-end">
            {% if message.internal_data.real_tokens is not None %}
              {% trans "Context consumption" %}: {{ message.internal_data.real_tokens }} / {{ message.internal_data.max_context }} ({% trans "real" %})
            {% elif message.internal_data.approx_tokens %}
              {% trans "Context consumption" %}: {{ message.internal_data.approx_tokens }} / {{ message.internal_data.max_context }} ({% trans "approximated" %})
            {% elif message.internal_data.context_tokens %} <!-- for backward compatibility -->
              {% trans "Context consumption" %}: {{ message.internal_data.context_tokens }} / {{ message.internal_data.max_context }} ({% trans "approximated" %})
            {% endif %}
          </div>
          {% endif %}
        </div>
        {% endif %}
      </div>
      {% endfor %}
    </div>

    <!-- Reserved space for scrolling -->
    <div id="scroll-spacer" style="height: 200px;"></div>
  </div>

  <!-- Progress indicator - fixed position when visible -->
  <div id="task-progress" class="d-none message-input-area p-3">
    <div class="d-flex align-items-center gap-3">
      <div class="spinner-border spinner-border-sm text-primary" role="status">
        <span class="visually-hidden">{% trans "Working..." %}</span>
      </div>
      <div class="flex-grow-1">
        <small id="progress-logs" class="text-muted"></small>
      </div>
      <div id="task-status"></div>
    </div>
  </div>

  <!-- Message input area - always visible at bottom -->
  {% with nb_agents=user_agents|length %} {% if nb_agents == 0 %}
  <div class="alert alert-info text-center message-input-area m-0 rounded-0">
    {% trans "No agents configured yet." %}<br />
    <a href="{% url 'user_settings:dashboard' %}#pane-agents" class="alert-link">
      {% trans "Create one now" %}
    </a>
  </div>
  {% else %}
  <div class="message-input-area p-3">
    <form id="message-form" method="post" enctype="multipart/form-data">
      {% csrf_token %}
      <input
        type="hidden"
        name="thread_id"
        value="{{ thread_id|default_if_none:'' }}"
      />
      
      <!-- Agent selection -->
      <div class="mb-2">
        <div class="dropdown">
          <button
            class="btn btn-outline-secondary dropdown-toggle btn-sm"
            type="button"
            data-bs-toggle="dropdown"
            aria-expanded="false"
            id="dropdownMenuButton"
          >
            {% if default_agent %} 
              <i class="bi bi-robot me-1"></i>{{ default_agent.name }} 
            {% else %} 
              {% trans "Select an agent" %} 
            {% endif %}
          </button>
          <ul class="dropdown-menu">
            {% for agent in user_agents %}
            <li>
              <a class="dropdown-item agent-dropdown-item" href="#" data-value="{{ agent.id }}">
                <i class="bi bi-robot me-2"></i>{{ agent.name }}
              </a>
            </li>
            {% endfor %}
            {% if nb_agents == 0 %}
            <li>
              <span class="dropdown-item-text text-muted">
                {% trans "No agents available" %}
              </span>
            </li>
            {% endif %}
          </ul>
          <button id="files-toggle-btn" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-files"></i>
          </button>
        </div>
        
        <!-- Hidden input -->
        <input
          type="hidden"
          name="selected_agent"
          id="selectedAgentInput"
          value="{% if default_agent %}{{ default_agent.id }}{% endif %}"
        />
      </div>

      <!-- Message input group -->
      <div class="input-group mb-2">
        <textarea class="form-control auto-resize-textarea"
                  name="new_message"
                  placeholder="{% trans 'Type your message...' %}"
                  rows="1"
                  maxlength="2000"
                  autofocus></textarea>
        <button
          type="submit"
          id="send-btn"
          class="btn btn-primary {% if nb_agents == 0 %}disabled{% endif %}"
          {% if nb_agents == 0 %}disabled{% endif %}
        >
          <i class="bi bi-send-fill"></i>
          <span class="visually-hidden">{% trans "Send" %}</span>
        </button>
      </div>
    </form>
  </div>
  {% endif %} {% endwith %}
</div>
