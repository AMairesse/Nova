{% extends 'base.html' %}
{% load i18n %} {% load static %}

{% block content %}
<div class="container-fluid h-100 p-0" style="overflow: hidden;">
  <!-- Main Content Area -->
  <div class="row g-0 main-content-row">
    <!-- Threads Sidebar (Desktop) -->
    <div class="col-lg-2 d-none d-lg-block border-end d-flex flex-column h-100" id="threads-sidebar">
      <div class="d-flex justify-content-between align-items-center p-3 border-bottom bg-light">
        <h5 class="mb-0">{% trans "Threads" %}</h5>
        <button class="btn btn-sm btn-outline-primary create-thread-btn">
          <i class="bi bi-plus"></i>
        </button>
      </div>
      <div id="threads-container">
        <div id="threads-list">
          {% include 'nova/partials/_thread_groups.html' with grouped_threads=grouped_threads %}
        </div>
        
        {% if has_more_threads %}
          <div class="text-center p-3" id="load-more-container">
            <button class="btn btn-outline-primary btn-sm" id="load-more-threads" data-offset="{{ next_offset }}">
              <i class="bi bi-arrow-down-circle me-1"></i>
              {% trans "Load More" %}
            </button>
          </div>
        {% endif %}
      </div>
    </div>
    
    <!-- Message Area (Center) -->
    <div class="col-12 d-flex flex-column h-100" id="message-area" data-files-visible="true">
      <div class="d-flex justify-content-between align-items-center p-3 border-bottom bg-light d-none d-lg-flex">
        <h5 class="mb-0">{% trans "Messages" %}</h5>
        <button class="btn btn-sm btn-outline-secondary" type="button" id="files-toggle-btn" aria-expanded="true" aria-controls="files-sidebar">
          <i class="bi bi-layout-sidebar-inset-reverse" id="files-toggle-icon"></i>
        </button>
      </div>
      <!-- Regular 3-pane view: only the messages container here -->
      <div id="message-container" class="d-flex flex-column flex-grow-1" style="min-height: 0;"></div>
    </div>
    
    <!-- Files Sidebar (Desktop) -->
    <div class="col-lg-2 d-none d-lg-block border-start d-flex flex-column h-100" id="files-sidebar">
      <div id="file-sidebar-content" class="flex-grow-1 overflow-auto" style="min-height: 0;"></div>
    </div>
  </div>

  <!-- Mobile Threads Offcanvas -->
  <div class="offcanvas offcanvas-start" tabindex="-1" id="threadsOffcanvas" aria-labelledby="threadsOffcanvasLabel">
    <div class="offcanvas-header border-bottom d-flex justify-content-between align-items-center">
      <h5 class="offcanvas-title" id="threadsOffcanvasLabel">{% trans "Threads" %}</h5>
      <div class="d-flex gap-2">
        <button class="btn btn-sm btn-outline-primary create-thread-btn">
          <i class="bi bi-plus"></i>
        </button>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
      </div>
    </div>
    <div class="offcanvas-body p-0 d-flex flex-column" style="min-height: 0;">
      <div id="mobile-threads-container">
        <div id="mobile-threads-list">
          {% include 'nova/partials/_thread_groups.html' with grouped_threads=grouped_threads %}
        </div>
        
        {% if has_more_threads %}
          <div class="text-center p-3" id="mobile-load-more-container">
            <button class="btn btn-outline-primary btn-sm" id="mobile-load-more-threads" data-offset="{{ next_offset }}">
              <i class="bi bi-arrow-down-circle me-1"></i>
              {% trans "Load More" %}
            </button>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Mobile Files/Webapps Offcanvas -->
  <div class="offcanvas offcanvas-end" tabindex="-1" id="filesOffcanvas" aria-labelledby="filesOffcanvasLabel">
    <div class="offcanvas-header border-bottom d-flex justify-content-between align-items-center">
      <h5 class="offcanvas-title" id="filesOffcanvasLabel">{% trans "Files & Webapps" %}</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body p-0 d-flex flex-column">
      <!-- Mobile tabs (Bootstrap 5 native tabs) -->
      <ul class="nav nav-tabs px-2 pt-2" id="mobile-files-webapps-tabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button
            class="nav-link active"
            id="mobile-tab-files"
            data-bs-toggle="tab"
            data-bs-target="#mobile-files-pane"
            type="button"
            role="tab"
            aria-controls="mobile-files-pane"
            aria-selected="true"
          >
            <i class="bi bi-files me-1"></i>{% trans "Files" %}
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="mobile-tab-webapps"
            data-bs-toggle="tab"
            data-bs-target="#mobile-webapps-pane"
            type="button"
            role="tab"
            aria-controls="mobile-webapps-pane"
            aria-selected="false"
          >
            <i class="bi bi-window me-1"></i>{% trans "Webapps" %}
          </button>
        </li>
      </ul>

      <!-- Mobile toolbar (shown only for Files tab; visibility also enforced via JS on tab change) -->
      <div class="d-flex justify-content-between align-items-center px-2 py-2 border-bottom bg-light" id="mobile-files-toolbar">
        <div class="small text-muted">{% trans "Upload files" %}</div>
        <div>
          <button id="upload-files-btn-mobile" class="btn btn-sm btn-primary me-1" title="{% trans 'Upload files' %}">
            <i class="bi bi-upload"></i>
          </button>
          <button id="upload-directory-btn-mobile" class="btn btn-sm btn-primary" title="{% trans 'Upload directory' %}">
            <i class="bi bi-folder-plus"></i>
          </button>
        </div>
      </div>

      <!-- Mobile tab panes -->
      <div class="tab-content flex-grow-1 overflow-auto" id="mobile-files-webapps-tabcontent">
        <div
          class="tab-pane fade show active"
          id="mobile-files-pane"
          role="tabpanel"
          aria-labelledby="mobile-tab-files"
          tabindex="0"
        >
          <!-- Files tree clone -->
          <div id="file-sidebar-content-mobile">
            <!-- Cloned from desktop sidebar; kept as-is -->
          </div>
        </div>

        <div
          class="tab-pane fade"
          id="mobile-webapps-pane"
          role="tabpanel"
          aria-labelledby="mobile-tab-webapps"
          tabindex="0"
        >
          <!-- Webapps list -->
          <div id="webapps-list-container-mobile" class="p-2">
            <p class="text-muted mb-0">{% trans "Loading webapps..." %}</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Mobile Message Context Menu (Action Sheet) -->
<div class="offcanvas offcanvas-bottom d-lg-none" tabindex="-1" id="messageContextMenu" aria-labelledby="messageContextMenuLabel">
  <div class="offcanvas-header py-2 border-bottom">
    <h6 class="offcanvas-title" id="messageContextMenuLabel">{% trans "Message Options" %}</h6>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="{% trans 'Close' %}"></button>
  </div>
  <div class="offcanvas-body">
    <!-- Context info (populated by JS) -->
    <div id="context-menu-info" class="context-info-item d-none">
      <span class="context-info-label">{% trans "Context" %}</span>
      <span class="context-info-value" id="context-menu-tokens"></span>
    </div>
    
    <!-- Actions -->
    <div class="d-grid gap-1">
      <button type="button" class="action-sheet-btn" id="context-menu-copy">
        <i class="bi bi-clipboard"></i>
        {% trans "Copy message" %}
      </button>
    </div>
  </div>
</div>

<!-- Scroll to bottom button -->
<button id="scroll-to-bottom" class="btn btn-primary position-fixed bottom-0 end-0 m-3 rounded-circle d-none" style="z-index: 1050;">
  <i class="bi bi-arrow-down"></i>
</button>


<script>
  // Configure URLs for the JavaScript modules
  window.NovaApp = window.NovaApp || {};
  window.NovaApp.urls = {
    index: "{% url 'index' %}",
    addMessage: "{% url 'add_message' %}",
    messageList: "{% url 'message_list' %}",
    runningTasksBase: "/running-tasks/",
    createThread: "{% url 'create_thread' %}",
    deleteThread: "{% url 'delete_thread' 0 %}",
    summarizeThread: "{% url 'summarize_thread' 0 %}",
    confirmSummarizeThread: "{% url 'confirm_summarize_thread' 0 %}",
    loadMoreThreads: "{% url 'load_more_threads' %}",
    fileList: "{% url 'file_list' 0 %}",
    fileUpload: "{% url 'file_upload' 0 %}",
    fileDelete: "{% url 'file_delete' 0 %}",
    interactionAnswer: "{% url 'interaction_answer' 0 %}",
    interactionCancel: "{% url 'interaction_cancel' 0 %}",
  };
</script>
<script src="{% static 'js/responsive.js' %}" defer></script>
<script src="{% static 'js/voice_recognition.js' %}" defer></script>
<script src="{% static 'js/message-renderer.js' %}" defer></script>
<script src="{% static 'js/streaming-manager.js' %}" defer></script>
<script src="{% static 'js/message-manager.js' %}" defer></script>
<script src="{% static 'js/preview-manager.js' %}" defer></script>
<script src="{% static 'js/thread-manager.js' %}" defer></script>
<script src="{% static 'js/file-operations.js' %}" defer></script>
<script src="{% static 'js/sidebar-manager.js' %}" defer></script>
<script src="{% static 'js/websocket-manager.js' %}" defer></script>
<script src="{% static 'js/webapp-integration.js' %}" defer></script>
<script src="{% static 'js/files.js' %}" defer></script>
<script src="{% static 'js/nova-thread-bootstrap.js' %}" defer></script>
{% endblock %}
