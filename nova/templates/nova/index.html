{% extends 'base.html' %}
{% load i18n %} {% load static %}

{% block content %}
<div class="container-fluid h-100 p-0" style="overflow: hidden;">
  <!-- Mobile Navigation (visible on small screens only) -->
  <nav class="navbar navbar-expand-lg d-lg-none bg-light border-bottom">
    <div class="container-fluid">
      <button class="btn btn-outline-secondary me-2" type="button" data-bs-toggle="offcanvas" data-bs-target="#threadsOffcanvas" aria-controls="threadsOffcanvas">
        <i class="bi bi-chat-dots"></i>
        <span class="d-none d-sm-inline ms-1">{% trans "Threads" %}</span>
      </button>
      <span class="navbar-brand mb-0 h1 flex-grow-1 text-center">{% trans "Messages" %}</span>
      <button class="btn btn-outline-secondary" type="button" data-bs-toggle="offcanvas" data-bs-target="#filesOffcanvas" aria-controls="filesOffcanvas">
        <i class="bi bi-files"></i>
        <span class="d-none d-sm-inline ms-1">{% trans "Files" %}</span>
      </button>
    </div>
  </nav>

  <!-- Main Content Area -->
  <div class="row g-0" style="height: calc(100vh - 76px); min-height: 0;">
    <!-- Threads Sidebar (Desktop) -->
    <div class="col-lg-2 d-none d-lg-block border-end d-flex flex-column h-100 overflow-hidden" id="threads-sidebar">
      <div class="d-flex justify-content-between align-items-center p-3 border-bottom bg-light">
        <h5 class="mb-0">{% trans "Threads" %}</h5>
        <button class="btn btn-sm btn-outline-primary create-thread-btn">
          <i class="bi bi-plus"></i>
        </button>
      </div>
      <div class="flex-grow-1" id="threads-container" style="min-height: 0; overflow-y: auto;">
        <div id="threads-list">
          {% include 'nova/partials/_thread_groups.html' with grouped_threads=grouped_threads %}
        </div>
        
        {% if has_more_threads %}
          <div class="text-center p-3" id="load-more-container">
            <button class="btn btn-outline-primary btn-sm" id="load-more-threads" data-offset="{{ next_offset }}">
              <i class="bi bi-arrow-down-circle me-1"></i>
              {% trans "Load More" %}
            </button>
          </div>
        {% endif %}
      </div>
    </div>
    
    <!-- Message Area (Center) -->
    <div class="col-12 d-flex flex-column h-100" id="message-area" data-files-visible="true">
      <div class="d-flex justify-content-between align-items-center p-3 border-bottom bg-light d-none d-lg-flex">
        <h5 class="mb-0">{% trans "Messages" %}</h5>
        <button class="btn btn-sm btn-outline-secondary" type="button" id="files-toggle-btn" aria-expanded="true" aria-controls="files-sidebar">
          <i class="bi bi-layout-sidebar-inset-reverse" id="files-toggle-icon"></i>
        </button>
      </div>
      <div id="message-container" class="d-flex flex-column flex-grow-1" style="min-height: 0;"></div>

      <!-- Web-app preview panel (hidden by default) -->
      <div id="webapp-panel" class="d-none border-top" style="min-height:0; height: 40%;">
        <div class="d-flex gap-2 p-1 border-bottom small bg-light align-items-center">
          <button class="btn btn-light btn-sm" id="webapp-refresh-btn" type="button" title="{% trans 'Refresh preview' %}">⟳</button>
          <a class="btn btn-light btn-sm" id="webapp-open-btn" href="#" target="_blank" rel="noopener noreferrer" title="{% trans 'Open in new tab' %}">↗ {% trans "Open" %}</a>
          <span class="ms-2 text-muted small" id="webapp-slug-label"></span>
        </div>
        <iframe
          id="webapp-iframe"
          data-webapp-slug=""
          sandbox="allow-scripts"
          style="width:100%; height: calc(100% - 32px); border:0"
        ></iframe>
      </div>

      <script>
        (function(){
          const panel   = document.getElementById('webapp-panel');
          const iframe  = document.getElementById('webapp-iframe');
          const openBtn = document.getElementById('webapp-open-btn');
          const refresh = document.getElementById('webapp-refresh-btn');
          const slugLbl = document.getElementById('webapp-slug-label');

          if (refresh) {
            refresh.addEventListener('click', () => {
              const src = iframe.getAttribute('src') || '';
              if (!src) return;
              try {
                const url = new URL(src, window.location.origin);
                url.searchParams.set('v', Date.now().toString());
                iframe.setAttribute('src', url.toString());
              } catch (e) {
                iframe.setAttribute('src', src + (src.includes('?') ? '&' : '?') + 'v=' + Date.now());
              }
            });
          }

          // Optional: listen to custom events (used by thread_management.js)
          document.addEventListener('webapp_update', (e) => {
            // Panel remains visible; iframe refresh handled in thread_management.js
            if (panel && !panel.classList.contains('d-none')) return;
          });

          // When the app URL is first announced, show the panel
          document.addEventListener('webapp_public_url', (e) => {
            const { slug, public_url } = e.detail || {};
            if (!public_url) return;
            if (iframe) {
              iframe.dataset.webappSlug = slug || '';
              iframe.setAttribute('src', public_url);
            }
            if (openBtn) openBtn.setAttribute('href', public_url);
            if (slugLbl) slugLbl.textContent = slug ? '(' + slug + ')' : '';
            if (panel) panel.classList.remove('d-none');
          });
        })();
      </script>
    </div>
    
    <!-- Files Sidebar (Desktop) -->
    <div class="col-lg-2 d-none d-lg-block border-start d-flex flex-column h-100 overflow-hidden" id="files-sidebar">
      <div class="d-flex justify-content-between align-items-center p-3 border-bottom bg-light">
        <h5 class="mb-0">{% trans "Files" %}</h5>
        <div>
          <button id="upload-files-btn" class="btn btn-sm btn-primary me-1" title="{% trans 'Upload files' %}">
            <i class="bi bi-upload"></i>
          </button>
          <button id="upload-directory-btn" class="btn btn-sm btn-primary" title="{% trans 'Upload directory' %}">
            <i class="bi bi-folder-plus"></i>
          </button>
        </div>
      </div>
      <div id="file-sidebar-content" class="flex-grow-1 overflow-auto" style="min-height: 0;"></div>
    </div>
  </div>

  <!-- Mobile Threads Offcanvas -->
  <div class="offcanvas offcanvas-start" tabindex="-1" id="threadsOffcanvas" aria-labelledby="threadsOffcanvasLabel">
    <div class="offcanvas-header border-bottom d-flex justify-content-between align-items-center">
      <h5 class="offcanvas-title" id="threadsOffcanvasLabel">{% trans "Threads" %}</h5>
      <div class="d-flex gap-2">
        <button class="btn btn-sm btn-outline-primary create-thread-btn">
          <i class="bi bi-plus"></i>
        </button>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
      </div>
    </div>
    <div class="offcanvas-body p-0 d-flex flex-column" style="min-height: 0;">
      <div id="mobile-threads-container" class="flex-grow-1" style="min-height: 0; overflow-y: auto;">
        <div id="mobile-threads-list">
          {% include 'nova/partials/_thread_groups.html' with grouped_threads=grouped_threads %}
        </div>
        
        {% if has_more_threads %}
          <div class="text-center p-3" id="mobile-load-more-container">
            <button class="btn btn-outline-primary btn-sm" id="mobile-load-more-threads" data-offset="{{ next_offset }}">
              <i class="bi bi-arrow-down-circle me-1"></i>
              {% trans "Load More" %}
            </button>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Mobile Files Offcanvas -->
  <div class="offcanvas offcanvas-end" tabindex="-1" id="filesOffcanvas" aria-labelledby="filesOffcanvasLabel">
    <div class="offcanvas-header border-bottom d-flex justify-content-between align-items-center">
      <h5 class="offcanvas-title" id="filesOffcanvasLabel">{% trans "Files" %}</h5>
      <div class="d-flex gap-2">
        <button id="upload-files-btn-mobile" class="btn btn-sm btn-primary" title="{% trans 'Upload files' %}">
          <i class="bi bi-upload"></i>
        </button>
        <button id="upload-directory-btn-mobile" class="btn btn-sm btn-primary" title="{% trans 'Upload directory' %}">
          <i class="bi bi-folder-plus"></i>
        </button>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
      </div>
    </div>
    <div class="offcanvas-body p-0">
      <div id="file-sidebar-content-mobile">
        <!-- Content loaded dynamically -->
      </div>
    </div>
  </div>
</div>

<!-- Scroll to bottom button -->
<button id="scroll-to-bottom" class="btn btn-primary position-fixed bottom-0 end-0 m-3 rounded-circle d-none" style="z-index: 1050;">
  <i class="bi bi-arrow-down"></i>
</button>


<script>
  // Configure URLs for the JavaScript modules
  window.NovaApp = window.NovaApp || {};
  window.NovaApp.urls = {
    addMessage: "{% url 'add_message' %}",
    messageList: "{% url 'message_list' %}",
    runningTasksBase: "/running-tasks/",
    createThread: "{% url 'create_thread' %}",
    deleteThread: "{% url 'delete_thread' 0 %}",
    loadMoreThreads: "{% url 'load_more_threads' %}",
    compactThread: "{% url 'compact_thread' 0 %}",
    fileList: "{% url 'file_list' 0 %}",
    fileUpload: "{% url 'file_upload' 0 %}",
    fileDelete: "{% url 'file_delete' 0 %}",
    interactionAnswer: "{% url 'interaction_answer' 0 %}",
    interactionCancel: "{% url 'interaction_cancel' 0 %}",
  };
</script>
<script src="{% static 'js/responsive.js' %}" defer></script>
<script src="{% static 'js/voice_recognition.js' %}" defer></script>
<script src="{% static 'js/thread_management.js' %}" defer></script>
<script src="{% static 'js/files.js' %}" defer></script>
{% endblock %}
