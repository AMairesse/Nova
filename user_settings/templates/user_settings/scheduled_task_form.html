{% extends "base.html" %}
{% load i18n crispy_forms_tags static %}

{% block title %}{{ title }}{% endblock %}

{% block extra_head %}
<script defer src="{% static 'user_settings/js/scheduled_task_form.js' %}"></script>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">{{ title }}</h5>
                </div>
                <div class="card-body">
                    <form method="post" id="scheduled_task_form" data-cron-preview-url="{% url 'user_settings:scheduled_task_cron_preview' %}">
                        {% csrf_token %}

                        {{ form.name|as_crispy_field }}
                        {{ form.trigger_type|as_crispy_field }}
                        {{ form.agent|as_crispy_field }}
                        {{ form.prompt|as_crispy_field }}
                        {{ form.run_mode|as_crispy_field }}

                        {{ form.cron_expression|as_crispy_field }}
                        <div class="card mb-3" id="cron_helper">
                            <div class="card-body">
                                <div class="mb-2">
                                    <label for="cron_preset" class="form-label mb-1">{% trans "Schedule helper" %}</label>
                                    <select id="cron_preset" class="form-select">
                                        <option value="custom">{% trans "Custom cron expression" %}</option>
                                        <option value="every_n_minutes">{% trans "Every N minutes" %}</option>
                                        <option value="hourly">{% trans "Hourly" %}</option>
                                        <option value="daily_at">{% trans "Daily at a specific time" %}</option>
                                        <option value="weekly_at">{% trans "Weekly at a specific time" %}</option>
                                        <option value="monthly_at">{% trans "Monthly at a specific time" %}</option>
                                    </select>
                                </div>

                                <div id="cron_params" class="row g-2 align-items-end" hidden>
                                    <div class="col-12 col-md-4" data-cron-param="every_n_minutes">
                                        <label for="cron_every_minutes" class="form-label">{% trans "Minutes" %}</label>
                                        <input id="cron_every_minutes" type="number" min="1" max="59" value="5" class="form-control">
                                    </div>

                                    <div class="col-12 col-md-4" data-cron-param="daily_at weekly_at monthly_at">
                                        <label for="cron_time" class="form-label">{% trans "Time" %}</label>
                                        <input id="cron_time" type="time" value="09:00" class="form-control">
                                    </div>

                                    <div class="col-12 col-md-4" data-cron-param="weekly_at">
                                        <label for="cron_weekday" class="form-label">{% trans "Weekday" %}</label>
                                        <select id="cron_weekday" class="form-select">
                                            <option value="1">{% trans "Monday" %}</option>
                                            <option value="2">{% trans "Tuesday" %}</option>
                                            <option value="3">{% trans "Wednesday" %}</option>
                                            <option value="4">{% trans "Thursday" %}</option>
                                            <option value="5">{% trans "Friday" %}</option>
                                            <option value="6">{% trans "Saturday" %}</option>
                                            <option value="0">{% trans "Sunday" %}</option>
                                        </select>
                                    </div>

                                    <div class="col-12 col-md-4" data-cron-param="monthly_at">
                                        <label for="cron_monthday" class="form-label">{% trans "Day of month" %}</label>
                                        <input id="cron_monthday" type="number" min="1" max="31" value="1" class="form-control">
                                    </div>
                                </div>

                                <div class="mt-2 small" id="cron_preview" aria-live="polite"></div>
                                <div class="small text-muted mt-1">
                                    {% trans "The cron expression is validated on save (server-side)." %}
                                </div>
                            </div>
                        </div>

                        {{ form.timezone|as_crispy_field }}
                        {{ form.email_tool|as_crispy_field }}
                        {{ form.poll_interval_minutes|as_crispy_field }}

                        <div class="d-flex justify-content-between">
                            <a href="{% url 'user_settings:scheduled_tasks' %}" class="btn btn-secondary">{% trans "Cancel" %}</a>
                            <button type="submit" class="btn btn-primary">{% trans "Save" %}</button>
                        </div>
                    </form>
                </div>
            </div>

        </div>
    </div>
</div>

{% endblock %}
